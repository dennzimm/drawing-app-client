import { IonToast } from '@ionic/react';
import React, { useEffect, useMemo, useRef, useState } from 'react';
import { NetworkStateMessages, useNetwork } from '../hooks/useNetwork.hook';

export enum NetworkInfoEvent {
  showNetworkInfo = 'showNetworkInfo',
}

const NetworkInfo: React.FC = () => {
  const { isOnline, networkState } = useNetwork();

  const options = useMemo(
    () => ({
      duration: 3000,
      message: NetworkStateMessages[networkState],
      color: isOnline ? 'success' : 'danger',
    }),
    [isOnline, networkState]
  );

  const toastRef = useRef<HTMLIonToastElement>(null);
  const [showNetworkInfo, setShowNetworkInfo] = useState(false);

  async function refreshToast() {
    if (toastRef.current) {
      await toastRef.current.dismiss();
    } else {
      setShowNetworkInfo(false);
    }

    setShowNetworkInfo(true);
  }

  useEffect(() => {
    refreshToast();
  }, [networkState]);

  useEffect(() => {
    const showNetworkInfo = () => {
      setShowNetworkInfo(true);
    };

    window.addEventListener(NetworkInfoEvent.showNetworkInfo, showNetworkInfo);

    return () => {
      window.removeEventListener(
        NetworkInfoEvent.showNetworkInfo,
        showNetworkInfo
      );
    };
  }, []);

  return (
    <IonToast
      ref={toastRef}
      position="top"
      isOpen={showNetworkInfo}
      onDidDismiss={() => setShowNetworkInfo(false)}
      message={options.message}
      color={options.color}
      duration={options.duration}
      buttons={[
        {
          text: 'Ok',
          role: 'cancel',
          handler: () => {
            setShowNetworkInfo(false);
          },
        },
      ]}
    />
  );
};

export default NetworkInfo;
